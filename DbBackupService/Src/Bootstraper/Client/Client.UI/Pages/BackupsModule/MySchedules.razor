@page "/schedules"

@using Client.UI.Data.Services
@using Client.UI.Pages.BackupsModule.Dialogs.Schedule
@using Microsoft.AspNetCore.SignalR.Client
@using Modules.Backup.Shared.Dtos
@using Modules.Backup.Shared.Helpers
@using Modules.Backup.Shared.Hubs
@using OneOf.Types

@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject BackupsHttpClientService Service
@inject NavigationManager Nav
@inject AuthStateProvider Auth

@implements IDisposable

<PageTitle>Backup Schedules</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-6">Backup Schedules</MudText>

    <MudPaper Class="pa-4 mud-elevation-2 rounded-2xl">
        <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-4">
            <MudText Typo="Typo.h6">Schedules list</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@_isProcessing" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenNewScheduleDialog">New Schedule</MudButton>
        </MudStack>

        <MudTable Items="@_schedules" Hover="true" Dense="true">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<BackupsScheduleDto, object>(x => x.ServerName!)">Server</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="new Func<BackupsScheduleDto, object>(x => x.IsEnabled)">Status</MudTableSortLabel></MudTh>
                <MudTh>Next Backup</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.ServerName</MudTd>
                <MudTd>
                    @if (context.IsEnabled)
                    {
                        <MudChip T="string" Color="Color.Success" Variant="Variant.Outlined">Enabled</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Color="Color.Error" Variant="Variant.Outlined">Disabled</MudChip>
                    }
                </MudTd>
                <MudTd>@BackupScheduleHelper.GetNextBackupDateString(context)</MudTd>
                <MudTd>
                    <MudIconButton Disabled="@_isProcessing" Icon="@Icons.Material.Filled.Edit" Color="Color.Warning"
                                   OnClick="() => OpenEditScheduleDialog(context)" />
                    <MudIconButton Disabled="@_isProcessing" Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                   OnClick="() => DeleteSchedule(context.Id)" />
                </MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager PageSizeOptions="@([25, 50, 100])" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<BackupsScheduleDto> _schedules = new();
    private List<ServerNameIdDto> _availableServers = new();
    private HubConnection? _hubConnection;
    private bool _isProcessing;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(
                await Auth.AuthorizeUser(returnPageAfterValidPasswordAuthorization: "schedules")))
            return;
        
        await FetchSchedules();

        var getAvailableServersResult = await Service.GetServersNamesForSchedulesAsync();
        getAvailableServersResult.Switch(
            list => _availableServers = list,
            error => Snackbar.Add(error, Severity.Error)
        );
        
        _hubConnection = BackupHubHelper.GetBasicHubConnection(Nav.ToAbsoluteUri(BackupHubHelper.HubUrl));
        _hubConnection.On<Guid>(BackupHubHelper.Events.ScheduleCreatedEvent.ToString(), (serverId) =>
        {
            if (_availableServers.FirstOrDefault(x => x.Id == serverId) is not null)
                InvokeAsync(FetchSchedules);
        });
        _hubConnection.On<Guid>(BackupHubHelper.Events.ScheduleHasChangedEvent.ToString(), (id) =>
        {
            if (_schedules.FirstOrDefault(x => x.Id == id) is not null)
                InvokeAsync(FetchSchedules);
        });

        await _hubConnection.StartAsync();
    }

    private async Task FetchSchedules()
    {
        _isProcessing = true;
        
        var getSchedulesResult = await Service.GetSchedulesAsync();
        getSchedulesResult.Switch(
            list => _schedules = list,
            error => Snackbar.Add(error, Severity.Error)
        );

        _isProcessing = false;
        StateHasChanged();
    }

    private async Task DeleteSchedule(Guid id)
    {
        _isProcessing = true;
        
        var result = await Service.DeleteScheduleAsync(id);
        
        result.Switch(
            async void (_) =>
            {
                Snackbar.Add("Successfully removed schedule.", Severity.Success);
                await FetchSchedules();
            },
            error => Snackbar.Add(error, Severity.Error)
        );

        _isProcessing = false;
    }

    private async Task OpenNewScheduleDialog()
    {
        var parameters = new DialogParameters<BackupScheduleDialog>
        {
            { x => x.AvailableServers, _availableServers }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        
        var dialog = await DialogService.ShowAsync<BackupScheduleDialog>("New Schedule", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled && result.Data is BackupsScheduleDto dto)
        {
            var createScheduleResult = await Service.CreateScheduleAsync(dto);
            
            createScheduleResult.Switch(
                async void (_) =>
                {
                    Snackbar.Add("Successfully created schedule.", Severity.Success);
                    await FetchSchedules();
                },
                error => Snackbar.Add(error, Severity.Error)
            );
        }
    }

    private async Task OpenEditScheduleDialog(BackupsScheduleDto schedule)
    {
        var parameters = new DialogParameters<BackupScheduleDialog>
        {
            { x => x.Schedule, schedule },
            { x => x.AvailableServers, _availableServers}
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        
        var dialog = await DialogService.ShowAsync<BackupScheduleDialog>("Edit Schedule", parameters, options);
        var result = await dialog.Result;

        if (!result!.Canceled && result.Data is BackupsScheduleDto dto)
        {
            var editScheduleResult = await Service.EditScheduleAsync(dto);
            
            editScheduleResult.Switch(
                async void (_) =>
                {
                    Snackbar.Add("Successfully edited schedule.", Severity.Success);
                    await FetchSchedules();
                },
                error => Snackbar.Add(error, Severity.Error)
            );
        }
    }

    public void Dispose()
    {
        _hubConnection?.DisposeAsync();
    }

}
