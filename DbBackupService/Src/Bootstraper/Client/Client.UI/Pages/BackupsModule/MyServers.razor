@page "/servers"

@using Client.UI.Data.Services
@using Client.UI.Pages.BackupsModule.Dialogs.Servers
@using Modules.Backup.Shared.Dtos

@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject BackupsHttpClientService Service

<PageTitle>Servers</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-6">
    <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-6">Moje serwery</MudText>

    <MudPaper Class="pa-4 mud-elevation-2 rounded-2xl">
        <MudStack Row="true" Class="mb-4">
            <MudText Typo="Typo.h6">Lista serwerów</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateNewServerDialog">Add server</MudButton>
        </MudStack>

        <MudTable Items="@_servers" Hover="true" Dense="true">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Host</MudTh>
                <MudTh>Database</MudTh>
                <MudTh>Tunnel Status</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Operations</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">@context.ConnectionName</MudTd>
                <MudTd DataLabel="Host">@context.ServerHost:@context.ServerPort</MudTd>
                <MudTd DataLabel="Database">@context.DbName</MudTd>
                <MudTd DataLabel="Tunnel Status">
                    @if (context.IsTunnelRequired)
                    {
                        <MudChip T="string" Variant="Variant.Text" Color="Color.Success">Enabled</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Variant="Variant.Text" Color="Color.Error">Disabled</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Type">@context.DbType</MudTd>
                <MudTd DataLabel="Operations">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" OnClick="@(() => OpenEditServerDialog(context))" />
                    <MudTooltip Delay="100" Text="Disable server">
                        <MudIconButton Icon="@Icons.Material.Filled.ChangeCircle" Color="Color.Secondary" />
                    </MudTooltip>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<ServerConnectionDto> _servers = new();

    protected override async Task OnInitializedAsync()
    {
        await FetchServers();
    }

    private async Task FetchServers()
    {
        var result = await Service.GetServersAsync();
        
        result.Switch(
            servers => _servers = servers,
            error => Snackbar.Add(error, Severity.Error)
        );
        
        StateHasChanged();
    }
    
    private async Task OpenEditServerDialog(ServerConnectionDto server)
    {
        var dialogParameters = new DialogParameters<EditServerDialog>
        {
            { x => x.Server, server }
        };
        
        var dialog = await DialogService.ShowAsync<EditServerDialog>($"Edit server {server.ConnectionName}", parameters: dialogParameters);
        
        var dialogResult = await dialog.Result;

        if (dialogResult is not null && !dialogResult.Canceled)
            await FetchServers();
    }

    private async Task OpenCreateNewServerDialog()
    {
        var dialog = await DialogService.ShowAsync<CreateServerDialog>("Create new server");
        
        var dialogResult = await dialog.Result;

        if (dialogResult is not null && !dialogResult.Canceled)
            await FetchServers();
    }
}