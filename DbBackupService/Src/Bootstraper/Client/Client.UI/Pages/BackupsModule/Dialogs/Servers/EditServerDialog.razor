@using Client.UI.Data.Services
@using Modules.Backup.Shared.Dtos
@using Modules.Backup.Shared.Enums
@inject ISnackbar SnackBar
@inject BackupsHttpClientService Service

<MudDialog>
    <DialogContent>
        <EditForm Model="Server" OnValidSubmit="Save"
                  OnInvalidSubmit="@(() => SnackBar.Add("Please check entered data", Severity.Warning))">
            <DataAnnotationsValidator/>

            <MudCard Elevation="3" Class="pa-4 rounded-2xl mb-5">
                <MudCardContent>
                    <MudGrid Spacing="3">
                        <MudItem xs="12">
                            <MudTextField Label="Connection Name" Disabled="@_isSaving"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Title"
                                          @bind-Value="Server.ConnectionName"
                                          For="@(() => Server.ConnectionName)"/>
                        </MudItem>

                        <MudItem xs="12" sm="8">
                            <MudTextField Label="Server Host" Disabled="@_isSaving"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Dns"
                                          @bind-Value="Server.ServerHost"
                                          For="@(() => Server.ServerHost)"/>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudNumericField T="short" Disabled="@_isSaving"
                                             Label="Port"
                                             Adornment="Adornment.Start"
                                             AdornmentIcon="@Icons.Material.Filled.Router"
                                             @bind-Value="Server.ServerPort"
                                             For="@(() => Server.ServerPort)"/>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Database Name" Disabled="@_isSaving"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.DataObject"
                                          @bind-Value="Server.DbName"
                                          For="@(() => Server.DbName)"/>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudSelect @bind-Value="Server.DbType" Label="Database Type" Disabled="@_isSaving"
                                       For="@(() => Server.DbType)">
                                <MudSelectItem Value="DatabaseType.MySql">MySQL</MudSelectItem>
                                <MudSelectItem Value="DatabaseType.PostgreSql">PostgreSQL</MudSelectItem>
                                <MudSelectItem Value="DatabaseType.SqlServer">SQL Server</MudSelectItem>
                            </MudSelect>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudTextField Label="DB User" Disabled="@_isSaving"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Person"
                                          @bind-Value="Server.DbUser"
                                          For="@(() => Server.DbUser)"/>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField Label="Password" Disabled="@_isSaving"
                                          InputType="InputType.Password"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Lock"
                                          @bind-Value="Server.DbPasswd"
                                          For="@(() => Server.DbPasswd)"/>
                        </MudItem>

                        <MudItem xs="12">
                            <MudSwitch T="bool" @bind-Value="Server.IsTunnelRequired" Disabled="@_isSaving"
                                       Label="Use SSH Tunnel?" Color="Color.Primary"/>
                        </MudItem>

                        @if (Server.IsTunnelRequired)
                        {
                            <MudItem xs="12">
                                <MudPaper Class="pa-4 rounded-xl mud-elevation-1">
                                    <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-3">
                                        Tunnel configuration
                                    </MudText>
                                    <MudGrid Spacing="3">
                                        <MudItem xs="12" sm="6">
                                            <MudTooltip Text="SSH server hostname or IP address, e.g. ssh.myserver.com">
                                                <MudTextField Label="Tunnel Host" Disabled="@_isSaving"
                                                              Adornment="Adornment.Start"
                                                              AdornmentIcon="@Icons.Material.Filled.Dns"
                                                              AdornmentColor="Color.Primary"
                                                              HelperText="Enter SSH server address"
                                                              @bind-Value="Server.Tunnel!.ServerHost"
                                                              For="@(() => Server.Tunnel!.ServerHost)"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12" sm="6">
                                            <MudTooltip Text="SSH username used to log into the server">
                                                <MudTextField Label="Tunnel Username" Disabled="@_isSaving"
                                                              Adornment="Adornment.Start"
                                                              AdornmentIcon="@Icons.Material.Filled.Person"
                                                              HelperText="Enter SSH login username"
                                                              @bind-Value="Server.Tunnel!.Username"
                                                              For="@(() => Server.Tunnel!.Username)"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12" sm="6">
                                            <MudTooltip
                                                Text="Password for SSH login (optional if private key is provided)">
                                                <MudTextField Label="Tunnel Password" Disabled="@_isSaving"
                                                              InputType="InputType.Password"
                                                              Adornment="Adornment.Start"
                                                              AdornmentIcon="@Icons.Material.Filled.Lock"
                                                              HelperText="SSH password"
                                                              @bind-Value="Server.Tunnel!.Password"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12" sm="6">
                                            <MudTooltip Text="Provide passphrase for your private key">
                                                <MudTextField Label="Private Key Passphrase" Disabled="@_isSaving"
                                                              Placeholder="Type password here..."
                                                              HelperText="Private key Passphrase"
                                                              @bind-Value="Server.Tunnel!.PrivateKeyPassphrase"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12" sm="6">
                                            <MudTooltip
                                                Text="Paste the content of your private key (.pem or .ppk converted to PEM)">
                                                <MudTextField Label="Private Key (PEM)" Lines="4" Disabled="@_isSaving"
                                                              Placeholder="Paste private key here..."
                                                              HelperText="Private key content"
                                                              @bind-Value="Server.Tunnel!.PrivateKeyContent"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12" sm="6">
                                            <MudTooltip
                                                Text="Override existing passwords and private key content with actual values">
                                                <MudSwitch T="bool" Label="Override Passwords and PEM"
                                                           Disabled="@_isSaving"
                                                           @bind-Value="Server.Tunnel!.OverridePasswordsAndPem"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12" sm="6">
                                            <MudTooltip Text="SSH port number (default: 22)">
                                                <MudNumericField T="int" Disabled="@_isSaving"
                                                                 Label="SSH Port"
                                                                 HelperText="Default: 22"
                                                                 @bind-Value="Server.Tunnel!.SshPort"
                                                                 For="@(() => Server.Tunnel!.SshPort)"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12" sm="6">
                                            <MudTooltip Text="Local port used to forward traffic (e.g. 5433)">
                                                <MudNumericField T="int" Disabled="@_isSaving"
                                                                 Label="Local Forward Port"
                                                                 HelperText="Local port for DB access"
                                                                 @bind-Value="Server.Tunnel!.LocalPort"
                                                                 For="@(() => Server.Tunnel!.LocalPort)"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12" sm="6">
                                            <MudTooltip
                                                Text="Database host address as seen from the SSH server (often 127.0.0.1)">
                                                <MudTextField Disabled="@_isSaving"
                                                              Label="Remote Host"
                                                              HelperText="Database host accessible via SSH"
                                                              @bind-Value="Server.Tunnel!.RemoteHost"
                                                              For="@(() => Server.Tunnel!.RemoteHost)"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12" sm="6">
                                            <MudTooltip
                                                Text="Database port (5432 for PostgreSQL, 3306 for MySQL, etc.)">
                                                <MudNumericField T="int" Disabled="@_isSaving"
                                                                 Label="Remote Port"
                                                                 HelperText="Port of the database server"
                                                                 @bind-Value="Server.Tunnel!.RemotePort"
                                                                 For="@(() => Server.Tunnel!.RemotePort)"/>
                                            </MudTooltip>
                                        </MudItem>

                                        <MudItem xs="12">
                                            <MudTooltip
                                                Text="Description for tunnel like any kind of additional info. (optional)">
                                                <MudTextField Disabled="@_isSaving" Lines="3"
                                                              Label="Description"
                                                              HelperText="Additional optional info"
                                                              @bind-Value="Server.Tunnel!.Description"/>
                                            </MudTooltip>
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <MudContainer Class="d-flex justify-between pa-4">
                <MudButton OnClick="Cancel" Variant="Variant.Text" Color="Color.Default" Disabled="@_isSaving">Cancel
                </MudButton>
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Success"
                           Disabled="@_isSaving">Save
                </MudButton>
            </MudContainer>
        </EditForm>
    </DialogContent>
</MudDialog>

@code {
    [Parameter] public required ServerConnectionDto Server { get; set; }

    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = null!;
    private bool _isSaving;

    protected override void OnInitialized()
    {
        Server.Tunnel ??= new ServerTunnelDto();
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Save()
    {
        _isSaving = true;

        var result = await Service.EditServerAsync(Server);

        result.Switch(
            _ =>
            {
                SnackBar.Add("Server changes saved", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            },
            error => SnackBar.Add(error, Severity.Error)
        );

        _isSaving = false;
    }

}
